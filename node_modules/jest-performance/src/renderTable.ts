import Table from 'cli-table'
import R from 'ramda'
import colors from 'colors'
import { head, Bench, Test } from './constants'

/**
 *
 *
 *
 *
 * ~~~ table
 *
 */
const table = new Table({
  head,
})

/**
 *
 *
 *
 *
 * ~~~ renderTable
 *
 */
const renderTable = (benches: Bench[], suiteName: string): void => {
  R.forEach((bench: Bench) => {
    const avgErrorPc =
      // @ts-ignore
      R.compose(R.sum, R.pluck('errorPc'))(bench.tests) / bench.tests.length
    R.forEach((test: Test): void => {
      const changes = colors[bench.git.changes > 0 ? 'red' : 'green'](`${bench.git.changes}`)
      table.push([
        test.name,
        new Date(bench.date).toLocaleString().replace(' ', '\n'),
        bench.git.branch.replace(' -> ', ' ->\n'),
        `${bench.git.commit} (${changes})`,
        test.samplesCount,
        `${test.durationMicroSeconds.toFixed(3)} Âµs`,
        colors[test.runSlowerRatio > 1 ? 'red' : 'green'](
          `${test.runSlowerRatio.toFixed(3)}x`,
        ),
        colors[test.errorPc < avgErrorPc ? 'green' : 'red'](
          `${test.errorPc.toFixed(3)} %`,
        ),
      ])
    })(bench.tests)
  })(benches)

  console.log(`\n${colors.yellow.bold(suiteName)}\n${table.toString()}`)
}

/**
 *
 *
 *
 *
 * ~~~ default
 *
 */
export default renderTable
